
parameters:
  AzureConnectionServiceName: ''
  SubscriptionGuid: ''
  KeyVaultResourceGroup: ''
  KeyVaultObjectId: ''
  sqAdminPassword: ''
  ResourceGroup: ''
  HostingPlan: ''
  Website: ''
  SqlServer: ''
  SqlDb: ''
  SkuSize: ''
  SkuCapacity: ''
  SqlAdmin: ''
  SqlAdminPassword: ''

steps:
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: "Deploy KeyVault"
    inputs:
      deploymentScope: 'Resource Group'
      ConnectedServiceName: '{{parameters.AzureConnectionServiceName}}'
      subscriptionName: '{{parameters.SubscriptionGuid}}'
      action: 'Create Or Update Resource Group'
      resourceGroupName: '{{parameters.KeyVaultResourceGroup}}'
      location: 'West Europe'
      templateLocation: 'Linked artifact'
      csmFile: '../AzureRessources/keyvault.azuredeploy.json'
      csmParametersFile: '../AzureRessources/keyvault.azuredeploy.parameters.json'
      overrideParameters: '-objectId "{{parameters.KeyVaultObjectId}}" -sqAdminPassword "{{parameters.sqAdminPassword}}"'
      deploymentMode: 'Incremental'
  - task: AzureResourceManagerTemplateDeployment@3
    displayName: "Deploy Infrastructure"
    inputs:
      deploymentScope: 'Resource Group'
      ConnectedServiceName: '{{parameters.AzureConnectionServiceName}}'
      subscriptionName: '{{parameters.SubscriptionGuid}}'
      action: 'Create Or Update Resource Group'
      resourceGroupName: '{{parameters.ResourceGroup}}'
      location: 'West Europe'
      templateLocation: 'Linked artifact'
      csmFile: '../AzureRessources/sonar.azuredeploy.json'
      csmParametersFile: '../AzureRessources/sonar.azuredeploy.parameters.json'
      overrideParameters: '-hostingPlanName "{{parameters.HostingPlan}}" -webSiteName "{{parameters.Website}}" -sqlserverName "{{parameters.SqlServer}}" -databaseName "{{parameters.SqlDb}}" -skuName "{{parameters.SkuSize}}" -skuCapacity "{{parameters.SkuCapacity}}" -sqlAdministratorLogin "{{parameters.SqlAdmin}}" -sqlAdministratorLoginPassword "{{parameters.SqlAdminPassword}}"'
      deploymentMode: 'Incremental'